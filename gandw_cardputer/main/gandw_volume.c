#include <stdint.h>
#include <stdbool.h>
#include "gandw_volume.h"
#include "esp_err.h"
#include "nvs_flash.h"
#include "esp_timer.h"
#include <gw_system.h>

uint16_t volume = 2000;
uint8_t volume_level = 2;
uint32_t volume_time = 0;
uint16_t volume_display_count = 0;

void read_volume() {
    nvs_handle_t my_handle;
    ESP_ERROR_CHECK(nvs_open("gandw", NVS_READWRITE, &my_handle));
    nvs_get_u8(my_handle, "volume_level", &volume_level);
    nvs_close(my_handle);

    if (volume_level > 10) {
        volume_level = 4;
    }

    volume = 10000 * (volume_level / 10.0);
}

void save_volume() {
    nvs_handle_t my_handle;
    ESP_ERROR_CHECK(nvs_open("gandw", NVS_READWRITE, &my_handle));
    ESP_ERROR_CHECK(nvs_set_u8(my_handle, "volume_level", volume_level));
    ESP_ERROR_CHECK(nvs_commit(my_handle));
    nvs_close(my_handle);
}

void set_volume(bool is_up) {

    uint32_t current_time = esp_timer_get_time() / 1000;

    if (current_time - volume_time > 200) {
        if (is_up) {
            if (volume_level < 10) {
                volume_level++;
            }
        }
        else {
            if (volume_level > 0) {
                volume_level--;
            }
        }

        volume = 10000 * (volume_level / 10.0);
        volume_time = current_time;
        volume_display_count = 255;
        save_volume();

    }
}

uint16_t get_volume_segment_colour(uint8_t seg_number) {

    if (seg_number > 3 && seg_number < 8) { //4, 5, 6, 7
        return 0xe0ff; // yellow: 0xffe0
    }
    else if (seg_number > 7) { // 8, 9, 10
        return 0x00f8; // yellow: 0xf800
    }
    else {
        return 0xe007; // green: 0x07e0
    }

}

void display_volume(unsigned short *framebuffer)
{
    uint8_t seg_count = 0;
    bool show_segment = false;
    uint8_t seg_number = 0;
    uint16_t pixel_colour = 0;
    uint16_t index = 0;

    uint16_t speakerIcon_13x20[] = {
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0x0000,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0x0000,0x0000,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0x0000,0x0000,0x0000,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xffff,
        0xffff,0x7294,0x0000,0x0000,0xffff,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xffff,
        0xffff,0x0000,0x0000,0x0000,0xffff,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xffff,
        0xffff,0x0000,0x0000,0x0000,0xffff,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xffff,
        0xffff,0x7294,0x0000,0x0000,0xffff,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0x0000,0x0000,0x0000,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0x0000,0x0000,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0x0000,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0x7294,0x0000,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,
        0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff
    };

    uint16_t pixel_pos = 0;
    for (uint8_t y = 3; y < 23; y++) {
        for (uint8_t x = 2; x < 15; x++) {
            index = y * GW_SCREEN_WIDTH + x;
            framebuffer[index] = speakerIcon_13x20[pixel_pos];

            pixel_pos++;
        }
    }

    for (uint8_t y = 3; y < 23; y++) {
        seg_count = 0;
        seg_number = 0;
        for (uint8_t x = 15; x < 85; x++) {
            index = y * GW_SCREEN_WIDTH + x;
            seg_count++;
            if ((seg_count == 5 && show_segment) || (seg_count == 2 && !show_segment)) {
                seg_count = 0;
                show_segment = !show_segment;

                if (show_segment) {
                    seg_number++;
                }
            }

            pixel_colour = 0x9ad6;

            if ((y > 3 && y < 22) && show_segment) {

                if (seg_count == 0 || seg_count == 4 || y == 4 || y == 21) {
                    pixel_colour = 0x2c63;
                }
                else {
                
                    if (volume_level >= seg_number) {
                        pixel_colour = get_volume_segment_colour(seg_number);
                    }
                    else {
                        pixel_colour = 0x518c;
                    }

                }
            }

            framebuffer[index] = pixel_colour;

        }
    }
}
